{% macro render_block(block, index=0) %}
<div class="mb-6 p-4 bg-white rounded shadow border border-gray-200">
  <h2 class="text-xl font-semibold text-gray-800 mb-2">{{ block.title }}</h2>
  <div class="text-gray-700 mb-4 leading-relaxed">
    {{ block.description | autolink | safe }}
  </div>

  {% if block.subblocks %}
  <div class="space-y-6">
    {% for sub in block.subblocks %}
      <div class="border border-gray-300 p-4 rounded info-section">
        <h3 class="font-medium text-gray-700 mb-1">{{ sub.title }}</h3>
        <div class="text-sm text-gray-700 mb-3 leading-relaxed whitespace-pre-line">
          {{ sub.description | autolink | safe }}
        </div>

        <label class="inline-flex items-center mb-3">
          <input type="checkbox"
                 class="form-checkbox text-blue-600 checkbox-confirm mr-2"
                 data-subblock-index="{{ loop.index0 }}"
                 data-block-index="{{ index }}">
          <span class="text-sm text-gray-700">–Ø –æ–∑–Ω–∞–π–æ–º–∏–≤—Å—è(–ª–∞—Å—å)</span>
        </label>
      </div>
    {% endfor %}
  </div>
{% endif %}

  <div class="mt-6">
    <button id="proceedToTest_{{ index }}"
            type="button"
            class="bg-blue-500 text-white px-4 py-2 rounded opacity-50 cursor-not-allowed"
            disabled>
      –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ç–µ—Å—Ç—É
    </button>
  </div>

  {% if (block.test and block.test.questions) or block.open_questions %}
    <div class="test-section hidden mt-6">
      <form method="POST" id="testFormBlock_{{ index }}" class="space-y-6">

        {# üîπ –í–æ–ø—Ä–æ—Å—ã —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞ –∏ open –≤–Ω—É—Ç—Ä–∏ —Ç–µ—Å—Ç–∞ #}
        {% if block.test and block.test.questions %}
          {% for q in block.test.questions %}
            {% set qid = 'q0_' ~ loop.index0 %}
            <div class="border p-4 rounded bg-white shadow">
              <h4 class="font-semibold mb-2">{{ loop.index }}. {{ q.question }}</h4>

              {% if q.type == 'open' %}
                <!-- üîπ –û—Ç–∫—Ä—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å (–≤–Ω—É—Ç—Ä–∏ —Ç–µ—Å—Ç–∞) -->
                <textarea name="{{ qid }}" 
                          class="w-full border rounded p-2" 
                          placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è"
                          required></textarea>
              {% else %}
                <!-- üîπ –í–æ–ø—Ä–æ—Å —Å –≤—ã–±–æ—Ä–æ–º -->
                {% for a in q.answers %}
                  <label class="block ml-4">
                    <input type="{{ 'checkbox' if q.get('multiple') else 'radio' }}"
                           name="{{ qid }}"
                           value="{{ a.value }}"
                           class="mr-2">
                    {{ a.value }}
                  </label>
                {% endfor %}
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

        {# üîπ –û—Ç–¥–µ–ª—å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (open_questions) #}
        {% if block.open_questions %}
          {% for oq in block.open_questions %}
            <div class="border p-4 rounded bg-white shadow">
              <h4 class="font-semibold mb-2">
                {{ (loop.index + (block.test.questions | length if block.test else 0)) }}. {{ oq.question }}
              </h4>
              <textarea name="open_q_{{ loop.index0 }}" 
                        class="w-full border rounded p-2" 
                        placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å"
                        required></textarea>
            </div>
          {% endfor %}
        {% endif %}

        <div id="submitWrap_{{ index }}" class="mt-6">
          <button type="submit"
                  class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç
          </button>
        </div>
      </form>
    </div>
  {% endif %}

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É -->
  <div id="resultModal_{{ index }}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md transform transition-all scale-95">
      <h2 class="text-2xl font-bold text-green-600 mb-2">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h2>
      <p id="resultTextModal_{{ index }}" class="text-gray-700 mb-4">
        –í–∏ –¥–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: X —ñ–∑ Y<br>–í—ñ–¥–∫—Ä–∏—Ç—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
      </p>
      <p id="motivationText_{{ index }}" class="italic text-sm text-gray-500 mb-6">
        –¢–∏ –º–æ–ª–æ–¥–µ—Ü—å, —Ç–∞–∫ —Ç—Ä–∏–º–∞—Ç–∏!
      </p>
      <a href="{{ url_for('main.manager_dashboard') }}"
         class="block text-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        –î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –±–ª–æ–∫—É
      </a>
    </div>
  </div>

  <script>
  setTimeout(function () {
    const checkboxes = document.querySelectorAll(".checkbox-confirm");
    const proceedBtn = document.getElementById("proceedToTest_{{ index }}");
    const form = document.getElementById("testFormBlock_{{ index }}");
    const testSection = form?.closest(".test-section");
    const infoSections = document.querySelectorAll(".info-section");
    const resultModal = document.getElementById("resultModal_{{ index }}");
    const resultTextModal = document.getElementById("resultTextModal_{{ index }}");
    const motivationText = document.getElementById("motivationText_{{ index }}");

    const motivations = [
      "–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üî•",
      "–©–µ –æ–¥–∏–Ω –∫—Ä–æ–∫ –¥–æ –≤–µ—Ä—à–∏–Ω–∏!",
      "–í–ø–µ–≤–Ω–µ–Ω–∏–π —Ä—É—Ö —É–ø–µ—Ä–µ–¥!",
      "–¢–≤–æ—è –≤–ø–µ—Ä—Ç—ñ—Å—Ç—å –Ω–∞–¥–∏—Ö–∞—î!",
      "–¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –ø—Ä–æ—Ñ—ñ!",
      "–¢–∞–∫ —Ç—Ä–∏–º–∞—Ç–∏! üí™"
    ];

    function updateButtonState() {
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      proceedBtn.disabled = !allChecked;
      proceedBtn.classList.toggle("opacity-50", !allChecked);
      proceedBtn.classList.toggle("cursor-not-allowed", !allChecked);
    }

    checkboxes.forEach(cb => cb.addEventListener("change", updateButtonState));

    if (proceedBtn) {
      proceedBtn.addEventListener("click", () => {
        if (testSection) testSection.classList.remove("hidden");
        infoSections.forEach(el => el.classList.add("hidden"));
        proceedBtn.classList.add("hidden");
      });
    }

    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(form);

        fetch("", {
          method: "POST",
          body: formData
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === "ok") {
              form.classList.add("hidden");
              resultTextModal.innerText = `‚úÖ –í–∏ –¥–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: ${data.correct} —ñ–∑ ${data.total_choice}\n–í—ñ–¥–∫—Ä–∏—Ç—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É`;
              motivationText.innerText = motivations[Math.floor(Math.random() * motivations.length)];
              resultModal.classList.remove("hidden");
            } else {
              alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ —Ç–µ—Å—Ç—É");
            }
          })
          .catch(err => {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞–ø–∏—Ç—É.");
          });
      });
    }
  }, 0);
  </script>
</div>
{% endmacro %}