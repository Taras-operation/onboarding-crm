{% macro render_block(block, index=0, test_started=False, test_completed=False) %}
<div id="block-{{ index }}"
     class="mb-6 p-4 bg-white rounded shadow border border-gray-200"
     data-started="{{ 1 if test_started else 0 }}"
     data-completed="{{ 1 if test_completed else 0 }}">

  <h2 class="text-xl font-semibold text-gray-800 mb-2">{{ block.title }}</h2>
  <div class="text-gray-700 mb-4 leading-relaxed">
    {{ block.description | autolink | safe }}
  </div>

  <div class="space-y-6 info-section {% if test_started and not test_completed %}hidden{% endif %}">
    {% if block.subblocks %}
      {% for sub in block.subblocks %}
        <div class="border border-gray-300 p-4 rounded">
          <h3 class="font-medium text-gray-700 mb-1">{{ sub.title }}</h3>
          <div class="text-sm text-gray-700 mb-3 leading-relaxed whitespace-pre-line break-words">
            {{ sub.description | autolink | safe }}
          </div>
          {% if not test_completed %}
          <label class="inline-flex items-center mb-3">
            <input type="checkbox"
                   class="form-checkbox text-blue-600 checkbox-confirm mr-2"
                   data-subblock-index="{{ loop.index0 }}"
                   data-block-index="{{ index }}">
            <span class="text-sm text-gray-700">–Ø –æ–∑–Ω–∞–π–æ–º–∏–≤—Å—è(–ª–∞—Å—å)</span>
          </label>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  </div>

  {% if not test_completed %}
    <div class="mt-6">
      <button id="proceedToTest_{{ index }}"
              type="button"
              class="bg-blue-500 text-white px-4 py-2 rounded opacity-50 cursor-not-allowed"
              disabled>
        –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ç–µ—Å—Ç—É
      </button>
    </div>
  {% endif %}

  <div class="test-section mt-6 {% if not (test_started and not test_completed) %}hidden{% endif %}">
    {% if (block.test and block.test.questions) or block.open_questions %}
      <form method="POST" id="testFormBlock_{{ index }}" class="space-y-6">
        {% if block.test and block.test.questions %}
          {% for q in block.test.questions %}
            {% set qid = 'q0_' ~ loop.index0 %}
            <div class="border p-4 rounded bg-white shadow">
              <h4 class="font-semibold mb-2">{{ loop.index }}. {{ q.question }}</h4>
              {% if q.type == 'open' %}
                <textarea name="{{ qid }}" class="w-full border rounded p-2" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è" required></textarea>
              {% else %}
                {% for a in q.answers %}
                  <label class="block ml-4">
                    <input type="{{ 'checkbox' if q.get('multiple') else 'radio' }}" name="{{ qid }}" value="{{ a.value }}" class="mr-2">
                    {{ a.value }}
                  </label>
                {% endfor %}
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}

        {% if block.open_questions %}
          {% for oq in block.open_questions %}
            <div class="border p-4 rounded bg-white shadow">
              <h4 class="font-semibold mb-2">
                {{ (loop.index + (block.test.questions | length if block.test else 0)) }}. {{ oq.question }}
              </h4>
              <textarea name="open_q_{{ loop.index0 }}" class="w-full border rounded p-2" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å" required></textarea>
            </div>
          {% endfor %}
        {% endif %}

        <div id="submitWrap_{{ index }}" class="mt-6">
          <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç
          </button>
        </div>
      </form>
    {% else %}
      <div class="text-sm text-gray-600">–î–ª—è —Ü—å–æ–≥–æ –±–ª–æ–∫—É –Ω–µ–º–∞—î —Ç–µ—Å—Ç–æ–≤–∏—Ö –ø–∏—Ç–∞–Ω—å.</div>
    {% endif %}
  </div>

  <div id="resultModal_{{ index }}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <h2 class="text-2xl font-bold text-green-600 mb-2">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h2>
      <p id="resultTextModal_{{ index }}" class="text-gray-700 mb-4"></p>
      <p id="motivationText_{{ index }}" class="italic text-sm text-gray-500 mb-6"></p>
      <a href="{{ url_for('main.manager_dashboard') }}"
         class="block text-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        –î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –±–ª–æ–∫—É
      </a>
    </div>
  </div>

  <script>
  setTimeout(function () {
    function getCSRFToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      return meta ? meta.getAttribute('content') : '';
    }

    const root = document.getElementById("block-{{ index }}");
    const infoSection = root.querySelector(".info-section");
    const testSection = root.querySelector(".test-section");
    const checkboxes = root.querySelectorAll(".checkbox-confirm");
    const proceedBtn = root.querySelector("#proceedToTest_{{ index }}");
    const form = root.querySelector("#testFormBlock_{{ index }}");
    const resultModal = root.querySelector("#resultModal_{{ index }}");
    const resultTextModal = root.querySelector("#resultTextModal_{{ index }}");
    const motivationText = root.querySelector("#motivationText_{{ index }}");
    const motivations = ["–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üî•","–©–µ –æ–¥–∏–Ω –∫—Ä–æ–∫ –¥–æ –≤–µ—Ä—à–∏–Ω–∏!","–í–ø–µ–≤–Ω–µ–Ω–∏–π —Ä—É—Ö —É–ø–µ—Ä–µ–¥!","–¢–≤–æ—è –≤–ø–µ—Ä—Ç—ñ—Å—Ç—å –Ω–∞–¥–∏—Ö–∞—î!","–¢–∏ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –ø—Ä–æ—Ñ—ñ!","–¢–∞–∫ —Ç—Ä–∏–º–∞—Ç–∏! üí™"];

    let started = root.dataset.started === '1';
    let completed = root.dataset.completed === '1';

    function showInfo() {
      infoSection?.classList.remove("hidden");
      testSection?.classList.add("hidden");
      if (proceedBtn) {
        proceedBtn.classList.remove("hidden");
        proceedBtn.disabled = true;
        proceedBtn.classList.add("opacity-50","cursor-not-allowed");
      }
    }

    function showTest() {
      infoSection?.classList.add("hidden");
      testSection?.classList.remove("hidden");
      proceedBtn?.classList.add("hidden");
    }

    (function enforceStartParam(){
      if (started && !completed) {
        try {
          const url = new URL(window.location.href);
          if (url.searchParams.get('start') !== '1') {
            url.searchParams.set('start', '1');
            history.replaceState(null, '', url.toString());
          }
        } catch (_) {}
      }
    })();

    if (completed) showInfo();
    else if (started) showTest();
    else showInfo();

    function updateButtonState() {
      if (!proceedBtn) return;
      if (checkboxes.length === 0) {
        proceedBtn.disabled = true;
        proceedBtn.classList.add("opacity-50","cursor-not-allowed");
        return;
      }
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      proceedBtn.disabled = !allChecked;
      proceedBtn.classList.toggle("opacity-50", !allChecked);
      proceedBtn.classList.toggle("cursor-not-allowed", !allChecked);
    }

    checkboxes.forEach(cb => cb.addEventListener("change", updateButtonState));
    updateButtonState();

    if (proceedBtn) {
      proceedBtn.addEventListener("click", async () => {
        try { await fetch(`/api/test/start/{{ index }}`, { method: 'POST' }); } catch (_) {}
        try {
          const url = new URL(window.location.href);
          url.searchParams.set('start', '1');
          history.replaceState(null, '', url.toString());
        } catch (_) {}
        started = true;
        showTest();
      });
    }

    if (form) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        formData.append('csrf_token', getCSRFToken());

        try {
          const res = await fetch("", {
            method: "POST",
            body: formData,
            credentials: "include"
          });
          const data = await res.json();

          try { await fetch(`/api/test/complete/{{ index }}`, { method: "POST" }); } catch (_) {}

          if (data.status === "ok") {
            form.classList.add("hidden");
            resultTextModal.innerText =
              `‚úÖ –í–∏ –¥–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: ${data.correct} —ñ–∑ ${data.total_choice}\n` +
              `–í—ñ–¥–∫—Ä–∏—Ç—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É`;
            motivationText.innerText = motivations[Math.floor(Math.random() * motivations.length)];
            resultModal.classList.remove("hidden");
          } else {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ —Ç–µ—Å—Ç—É");
          }
        } catch (err) {
          alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –∑–∞–ø–∏—Ç—É.");
        }
      });
    }

    window.addEventListener("pageshow", function () {
      if (started && !completed) showTest();
    });
    window.addEventListener("popstate", function () {
      if (started && !completed) {
        try {
          const url = new URL(window.location.href);
          url.searchParams.set('start', '1');
          history.replaceState(null, '', url.toString());
        } catch (_) {}
        showTest();
      }
    });
    window.addEventListener("unload", function(){});
  }, 0);
  </script>
</div>
{% endmacro %}